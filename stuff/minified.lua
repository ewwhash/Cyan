local component,computer,unicode,math,a,b,c,d,e,f,g,h,i,j=component,computer,unicode,math,{"/init.lua","/OS.lua"},{},{}local function k(l)local m={computer.pullSignal(l)}m[1]=m[1]or""if cyan and(m[1]:match("ey")and not cyan:match(m[5])or m[1]:match("cl")and not cyan:match(m[4]))then return""end;c[m[4]or""]=m[1]:match"do"and 1;return table.unpack(c[29]and(c[46]or c[32])and m[1]:match"do"and{"F"}or m)end;local function n(o)return component.list(o)()and component.proxy(component.list(o)())end;local function p(q,r)j={}for s in q:gmatch"[^\r\n]+"do j[#j+1]=s:gsub("\t",r and"    "or"")end end;local function t(l,u,v,w,x,y,z)w=computer.uptime()+(l or math.huge)::A::x,z,z,y=k(w-computer.uptime())if x=="F"or x:match"do"and(y==u or u==0)then return 1,v and v()elseif computer.uptime()<w then goto A end end;local function B(C,D,E,G,H)g.setBackground(G or 0x002b36)g.setForeground(H or 0x8cb9c5)g.set(C,D,E)end;local function I(C,D,J,K,G,H)g.setBackground(G or 0x002b36)g.setForeground(H or 0x8cb9c5)g.fill(C,D,J,K," ")end;local function L()I(1,1,e,f)end;local function M(N)return math.floor(e/2-N/2)end;local function O(D,q,G,H)B(M(unicode.len(q)),D,q,G,H)end;local function P()g,h=n"gp",n"sc"if g.getScreen()~=h.address then g.bind(h.address)end;g.setPaletteColor(9,0x002b36)g.setPaletteColor(11,0x8cb9c5)local Q,R,S=h.getAspectRatio()e,f=g.maxResolution()if not n"able"then S=2*(16*Q-4.5)/(16*R-4.5)f=S>e/f and math.floor(e/S)or f;e=math.floor(f*S)end;g.setResolution(e,f)end;local function T(q,U,V,u,v,D)L()p(q)D=math.ceil(f/2-#j/2)if U then O(D-1,U,0x002b36,0xffffff)D=D+1 end;for W=1,#j do O(D,j[W],g.getDepth()<2 and 0xffffff,g.getDepth()<2 and 0x000000)D=D+1 end;t(V or 0,u or 0,v)end;local function X(q,Y)return unicode.len(q)>Y and unicode.sub(q,1,Y).."…"or q end;local function Z(_,D,a0,a1,H)local q,a2,a3,a4,a5,C,x,a6,y,z="",unicode.len(_),1,1;H=H or 0x8cb9c5::A::C=a0 and M(unicode.len(q)+a2)or 1;a5=C+a2+a3-1;I(1,D,e,1)B(C,D,_..q,F,H)if a5<=e then B(a5,D,g.get(a5,D),a4 and H or 0x002b36,a4 and 0x002b36 or H)end;x,z,a6,y=k(.5)if x:match"do"then if y==203 and a3>1 then a3=a3-1 elseif y==205 and a3<=unicode.len(q)then a3=a3+1 elseif y==200 and a1 then q=a1;a3=unicode.len(a1)+1 elseif y==208 and a1 then q=""a3=1 elseif y==14 and#q>0 and a3>1 then q=c[29]and""or unicode.sub(unicode.sub(q,1,a3-1),1,-2)..unicode.sub(q,a3,-1)a3=c[29]and 1 or a3-1 elseif y==28 then return q elseif a6>=32 and unicode.len(a2 ..q)<e-a2 then q=unicode.sub(q,1,a3-1)..unicode.char(a6)..unicode.sub(q,a3,-1)a3=a3+1 end;a4=1 elseif x:match"cl"then q=unicode.sub(q,1,a3-1)..a6 ..unicode.sub(q,a3,-1)a3=a3+unicode.len(a6)elseif x:match"mp"or x=="F"then i=x:match"mp"and 1;return elseif not x:match"up"then a4=not a4 end;goto A end;local function a7(y,a8,a9,aa,ab)ab=ab or xpcall;local ac,ad=load("return "..y,a8,F,a9)if not ac then ac,ad=load(y,a8,F,a9)end;if ac then if aa and g then t(.3)I(1,1,e or 0,f or 0,0)g.setPaletteColor(9,0x969696)g.setPaletteColor(11,0xb4b4b4)end;return ab(ac,debug.traceback)end;return F,ad end;local function ae(af)local n,ag,ah,W=component.proxy(af),{s=1,z=1}if n and af~=computer.tmpAddress()then W=#b+1;b[W]={r=n,l=ag,d=n,p=function(ai,D)ai=ai and L()or ai;O(D or f/2,ai and("Booting %s from %s (%s)"):format(ah,n.getLabel()or"N/A",X(af,e>80 and 36 or 6))or ah and("Boot%s %s (%s)"):format((#ag==1 and" "..ah or"").." from",n.getLabel()or"N/A",X(af,6))or("Boot from %s (%s) isn't available"):format(n.getLabel()or"N/A",X(af,6)),F,not ai and 0xffffff)ai=ai and not d and cyan and(cyan:match("+")and pcall(T,"Hold ENTER to boot",F,math.huge,28))end}b[W].b=function()if ah then local aj,ak,ac,al,ad=n.open(ah,"r"),""::A::ac=n.read(aj,math.huge)if ac then ak=ak..ac;goto A end;n.close(aj)pcall(b[W].p,1)ac=computer.getBootAddress()~=af and computer.setBootAddress(af)al,ad=a7(ak,"="..ah,F,1)al=al and pcall(computer.shutdown)pcall(P)pcall(T,ad,"¯\\_(ツ)_/¯",math.huge,0,computer.shutdown)error(ad)end end;for am=1,#a do if n.exists(a[am])then ah=ah or a[am]ag[#ag+1]={a[am],function()ah=a[am]b[W].b()end}end end end end;local function an()b={}ae(computer.getBootAddress()or"")for af in next,component.list"file"do ae(af~=computer.getBootAddress()and af or"")end end;local function ao(ap,D,aq,ar,as,at)local au,C=0;for W=1,#ap do au=au+unicode.len(ap[W][1])+aq end;au=au-aq;C=M(au)if at then at()end;for W=1,#ap do if ap.s==W and as then I(C-aq/2,D-math.floor(ar/2),unicode.len(ap[W][1])+aq,ar,0x8cb9c5)B(C,D,ap[W][1],0x8cb9c5,0x002b36)else B(C,D,ap[W][1],0x002b36,0x8cb9c5)end;C=C+unicode.len(ap[W][1])+aq end end;local function av(a9,ak,aw,q)L()a9=setmetatable({print=function(...)q=table.pack(...)for W=1,q.n do if type(q[W]):match"able"then aw=''for ax,ay in pairs(q[W])do aw=aw..tostring(ax).."    "..tostring(ay).."\n"end;q[W]=aw end;q[W]=tostring(q[W])end;p(table.concat(q,"    "),1)for W=1,#j do g.copy(1,1,e,f-1,0,-1)I(1,f-1,e,1)B(1,f-1,j[W])end end,proxy=n,sleep=function(l)t(l,32,error)end},{__index=_G})::A::ak=Z("> ",f,F,ak,0xffffff,a9)if ak then a9.print("> "..ak)I(1,f,e,1)B(1,f,">")a9.print(select(2,a7(ak,"=shell",a9)))goto A end end;local function az()d=1,not g and error"No drives available"::aA::local aB,aC,aD,aE,x,y,aF,aG,D,aH,aI,aJ,z={s=1}aD={s=1,p=1,{"Halt",computer.shutdown},{"Shell",av},n"net"and{"Netboot",function()L()O(f/2-1,"Netboot",F,0xffffff)aG=Z("URL: ",f/2+1,1,F,0x8cb9c5)if aG and#aG>0 then local aj,ak,ac=n"net".request(aG,F,F,{["user-agent"]="Netboot"}),""if aj then T("Downloading script...","Netboot")::A::ac=aj.read()if ac then ak=ak..ac;goto A end;ak=select(2,a7(ak,"=stdin",F,1,pcall))or""pcall(P)pcall(T,ak,"Netboot",#ak==0 and 0 or math.huge)else T("Invalid URL","Netboot",math.huge)end end end}}aC=#aD+1;i=F;aI=F;function aJ()an()for W=1,#b do aB[W]={X(b[W].d.getLabel()or"N/A",6),function()if#b[W].l>0 then aI=W;aE=b[aI].l;if#aE==1 then aE[1][2]()end end end}end end;aJ()aE=#b>0 and aB or aD::A::pcall(function()L()if aE.z then O(f/2-2,"Select boot entry",F,0xffffff)ao(aE,f/2+2,6,3,1)else D=f/2-(#b>0 and-1 or 1)ao(aB,D-4,8,3,not aE.p and 1,function()if#b>0 then aH=b[aB.s].r;b[aB.s].p(F,D+3)O(D+5,("Storage %s%% / %s / %s"):format(math.floor(aH.spaceUsed()/(aH.spaceTotal()/100)),aH.isReadOnly()and"Read only"or"Read & Write",aH.spaceTotal()<2^20 and"FDD"or aH.spaceTotal()<2^20*12 and"HDD"or"RAID"))for W=aC,#aD do aD[W]=F end;aD[aC]={"Rename",function()L()O(f/2-1,"Rename",F,0xffffff)aF=Z("Enter new name: ",f/2+1,1,F,0x8cb9c5)if aF and#aF>0 and pcall(aH.setLabel,aF)then aH.setLabel(aF)aJ()end end}if not aH.isReadOnly()then aD[aC+1]={"Format",function()aH.remove("/")aH.setLabel(F)aJ()end}end else O(D+3,"No drives available",F,0xffffff)end end)ao(aD,D,6,1,aE.p and 1 or F)end end)if x and x:match"mp"or i then pcall(P)goto aA end;x,z,z,y=k()z=x=="F"and computer.shutdown()if x:match"do"and g and h then aE=(y==200 or y==208)and(aE.z and aB or#b>0 and(aE.p and aB or aD))or aE;aE.s=y==203 and(aE.s==1 and#aE or aE.s-1)or y==205 and(aE.s==#aE and 1 or aE.s+1)or aE.s;if y==28 then aE[aE.s][2]()end end;goto A end;computer.getBootAddress=function()return n"pro"and n"pro".getData()end;computer.setBootAddress=function(aK)return n"pro"and n"pro".setData(aK)end;an()pcall(P)if g.getDepth()>1 then pcall(T,"Hold ALT to stay in bootloader",F,1,56,az)else pcall(T,"Boot menu unsupported",F,1,56)end;for W=1,#b do b[W].b()end;az()
